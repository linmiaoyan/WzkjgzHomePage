{% extends 'base.html' %}

{% block title %}{{ task.title }} - QuickForm{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="d-flex justify-content-between items-center mb-4">
            <h2>{{ task.title }}</h2>
            <div>
                <a href="{{ url_for('quickform.export_data', task_id=task.id) }}" class="btn btn-success me-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download" viewBox="0 0 16 16">
                        <path d="M8 4a.5.5 0 0 1 .5.5v8a.5.5 0 0 1-1 0v-8A.5.5 0 0 1 8 4z"/>
                        <path d="M8 1a7 7 0 1 0 0 14A7 7 0 0 0 8 1zM1.5 8a6.5 6.5 0 1 1 13 0 6.5 6.5 0 0 1-13 0z"/>
                    </svg>
                    导出数据
                </a>
                <a href="{{ url_for('quickform.smart_analyze', task_id=task.id) }}" class="btn btn-info me-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-bar-chart2" viewBox="0 0 16 16">
                        <path d="M1 3a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V3zm5 2v8h2V5H6zm4 0v8h2V5h-2zm4 0v8h2V5h-2z"/>
                    </svg>
                    数据分析
                </a>
                <a href="{{ url_for('quickform.edit_task', task_id=task.id) }}" class="btn btn-primary me-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil" viewBox="0 0 16 16">
                        <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                    </svg>
                    编辑任务
                </a>
                <a href="{{ url_for('quickform.dashboard') }}" class="btn btn-secondary">返回列表</a>
            </div>
        </div>
        
        <!-- 任务信息卡片 -->
        <div class="card mb-4">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">任务信息</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>创建时间：</strong>{{ task.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                        <p><strong>提交数量：</strong>{{ submission|length }}</p>
                    </div>

                </div>
                {% if task.description %}
                <div class="mt-3">
                    <strong>任务描述：</strong>
                    <p>{{ task.description }}</p>
                </div>
                {% endif %}
                
                {% if task.file_name %}
                <div class="mt-3">
                    <strong>⚠可以上传学生使用html文件，以便模型更详细的分析，上传后可在互联网访问到该页面：</strong>
                    <a href="{{ url_for('quickform.uploaded_file', filename=saved_filename) }}" target="_blank" class="btn btn-outline-primary btn-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-earmark" viewBox="0 0 16 16">
                            <path d="M14 4.5V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h5.5L14 4.5zm-3-2A1.5 1.5 0 0 1 9.5 0H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V4.5a1.5 1.5 0 0 1-1.5 1.5H11a1.5 1.5 0 0 1-1.5-1.5z"/>
                        </svg>
                        {{ task.file_name }}
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- POST指令提示词卡片 -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-code-square" viewBox="0 0 16 16" style="margin-right: 8px;">
                        <path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/>
                        <path d="M6.854 4.646a.5.5 0 0 1 0 .708L4.207 8l2.647 2.646a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 0 1 .708 0zm2.292 0a.5.5 0 0 0 0 .708L11.793 8l-2.647 2.646a.5.5 0 0 0 .708.708l3-3a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708 0z"/>
                    </svg>
                    提交代码提示词
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">生成应用后，通过POST指令提交数据到以下URL：</p>
                
                <!-- URL显示 -->
                <div class="mb-3">
                    <label class="form-label"><strong>提交URL：</strong></label>
                    <div class="input-group">
                        <input type="text" class="form-control" readonly value="{{ request.host_url }}quickform/api/submit/{{ task.task_id }}" id="post-url">
                        <button class="btn btn-outline-secondary" onclick="copyToClipboard('post-url')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16">
                                <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/>
                                <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/>
                            </svg>
                            复制URL
                        </button>
                    </div>
                </div>
                
                <!-- 提示词模板 -->
                <div class="mb-3">
                    <label class="form-label"><strong>精简版提示词（点击复制）：</strong></label>
                    <div class="input-group">
                        <textarea class="form-control" id="simple-prompt-text" rows="2" readonly style="font-family: 'Courier New', monospace; font-size: 13px;">向这个网址 '{{ request.host_url }}quickform/api/submit/{{ task.task_id }}' 发送 json 格式的 POST 请求</textarea>
                        <button class="btn btn-outline-primary" onclick="copyToClipboardText('simple-prompt-text')">复制</button>
                    </div>
                </div>

                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="form-label mb-0"><strong>完整版提示词（默认折叠，点击展开/复制）：</strong></label>
                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#fullPromptCollapse" aria-expanded="false">展开/收起</button>
                    </div>
                    <div class="collapse" id="fullPromptCollapse">
                        <div class="input-group">
                            <textarea class="form-control" id="prompt-text" rows="15" readonly style="font-family: 'Courier New', monospace; font-size: 13px;">生成应用后，产生的数据用以下方法传到服务器：

<script>
function sendTestData() {
    const url = '{{ request.host_url }}quickform/api/submit/{{ task.task_id }}';
    const data = {"字段1": "值1", "字段2": "值2"};
    document.getElementById('send-result').textContent = "提交中...";
    fetch(url, {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data)})
    .then(async r => {
        const text = await r.text();
        let json = {};
        try { json = JSON.parse(text); } catch(e) { json = {raw: text}; }
        if (!r.ok) throw new Error(json.error || json.message || `HTTP ${r.status}`);
        return json;
    })
    .then(d => {
        document.getElementById('send-result').textContent = "提交成功: " + JSON.stringify(d);
        document.getElementById('send-result').style.color = '#28a745';
        console.log('提交成功:', d);
    })
    .catch(e => {
        document.getElementById('send-result').textContent = "提交失败: " + e.message;
        document.getElementById('send-result').style.color = '#dc3545';
        console.error('提交失败:', e, 'URL:', url, 'Data:', data);
    });
}
</script></textarea>
                            <button class="btn btn-primary" onclick="copyToClipboardText('prompt-text')">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M10.854 7.146a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L7.5 9.793l2.646-2.647a.5.5 0 0 1 .708 0z"/>
                                    <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/>
                                </svg>
                                复制提示词
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 提交数据列表 -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">提交数据列表</h5>
                {% if submission %}
                <button type="button" class="btn btn-danger btn-sm" onclick="deleteAllData()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                        <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                    </svg>
                    删除全部数据
                </button>
                {% endif %}
            </div>
            <div class="card-body">
                {% if submission %}
                <div class="overflow-auto">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>提交时间</th>
                                <th>数据内容</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for sub in submission %}
                            <tr>
                                <td>{{ sub.id }}</td>
                                <td>{{ sub.submitted_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                <td>
                                    <div class="d-flex gap-2">
                                        <button 
                                            type="button" 
                                            class="btn btn-link p-0"
                                            data-sub-id="{{ sub.id }}"
                                            data-sub-time="{{ sub.submitted_at.strftime('%Y-%m-%d %H:%M:%S') }}"
                                            data-sub-data='{{ sub.data | tojson | safe }}'
                                            onclick="openDataModal(this);">
                                            查看数据
                                        </button>
                                        <button 
                                            type="button" 
                                            class="btn btn-sm btn-danger"
                                            onclick="deleteSingleData({{ sub.id }})">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                                                <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                                <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                            </svg>
                                            删除
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- 分页 -->
                <div class="mt-4">
                    <p class="text-center">共 {{ submission|length }} 条记录</p>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <div class="mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="#6c757d" class="bi bi-database" viewBox="0 0 16 16">
                            <path d="M4.406 1.342A5.53 5.53 0 0 1 8 0c2.69 0 4.923 2 5.166 4.579C14.758 4.804 16 6.137 16 7.773 16 9.569 14.502 11 12.687 11H10a.5.5 0 0 1 0-1h2.688C13.979 10 15 8.988 15 7.773c0-1.216-1.02-2.228-2.313-2.228h-.5v-.5C12.188 2.825 10.328 1 8 1a4.53 4.53 0 0 0-2.941 1.1c-.757.652-1.153 1.438-1.153 2.055v.448l-.445.049C2.064 4.805 1 5.952 1 7.318 1 8.785 2.23 10 3.781 10H6a.5.5 0 0 1 0 1H3.781C1.708 11 0 9.366 0 7.318c0-1.763 1.266-3.223 2.942-3.593.143-.863.698-1.723 1.464-2.383z"/>
                            <path d="M6.5 16a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-1H6.5v1zm-2-1a.5.5 0 0 0 .5.5h7a.5.5 0 0 0 .5-.5v-1H4.5v1z"/>
                        </svg>
                    </div>
                    <h4>暂无提交数据</h4>
                    <p class="text-muted mb-4">当用户通过表单提交数据后，将在这里显示</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
    function copyToClipboard(elementId) {
        const element = document.getElementById(elementId);
        element.select();
        element.setSelectionRange(0, 99999);
        document.execCommand('copy');
        
        // 显示复制成功提示
        const btn = element.nextElementSibling;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check" viewBox="0 0 16 16"><path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/></svg> 已复制';
        
        setTimeout(() => {
            btn.innerHTML = originalText;
        }, 2000);
    }
    
    function copyToClipboardText(textareaId) {
        const textarea = document.getElementById(textareaId);
        textarea.select();
        textarea.setSelectionRange(0, 99999);
        document.execCommand('copy');
        
        // 显示复制成功提示
        const btn = textarea.nextElementSibling;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-circle" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M10.97 4.97a.235.235 0 0 0-.02.022L7.477 9.417 2.3 6.896a.235.235 0 0 0-.307.01l-.89.89a.5.5 0 0 0 .696.697l1.656-1.656a.235.235 0 0 0 .022-.023l3.473-4.425a.5.5 0 0 1 .703-.03l3.5 3.5a.5.5 0 0 1 .03.703z"/></svg> 已复制';
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-success');
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-primary');
        }, 2000);
    }

    // 单一全局模态框，避免滚动时出现多个悬浮窗
    (function ensureSingleModal(){
        if (document.getElementById('singleDataModal')) return;
        const modalWrap = document.createElement('div');
        modalWrap.id = 'singleDataModal';
        modalWrap.style.cssText = 'display:none; position:fixed; inset:0; z-index:1050;';
        modalWrap.innerHTML = `
            <div style="position:fixed; inset:0; background:rgba(0,0,0,0.2);"></div>
            <div style="position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); margin:0; display:flex; align-items:center; justify-content:center;">
                <div class="modal-content" style="width:90%; height:90%; max-height:500px; max-width:900px; display:flex; flex-direction:column; background:white; margin:0; padding:0;">
                    <div class="modal-header" style="padding:10px 15px; border-bottom:1px solid #dee2e6; margin:0;">
                        <h5 id="singleDataModalTitle" class="modal-title" style="margin:0; font-size:16px;">提交数据详情</h5>
                        <button type="button" class="btn-close" onclick="hideDataModal()" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" style="padding:15px; flex-grow:1; overflow-y:auto; margin:0;">
                        <p style="margin:0 0 10px 0; font-size:14px;"><strong>提交时间：</strong><span id="singleDataModalTime"></span></p>
                        <div style="margin:0;">
                            <h6 style="margin:0 0 8px 0; font-size:14px;">数据内容：</h6>
                            <pre id="singleDataModalContent" class="bg-light p-3 rounded overflow-auto" style="font-size:16px; line-height:1.6; white-space:pre-wrap; word-wrap:break-word; margin:0; min-height:300px;"></pre>
                        </div>
                    </div>
                    <div class="modal-footer" style="padding:10px 15px; border-top:1px solid #dee2e6; justify-content:flex-end; margin:0;">
                        <button type="button" class="btn btn-secondary" onclick="hideDataModal()">关闭</button>
                    </div>
                </div>
            </div>`;
        document.body.appendChild(modalWrap);
        // 点击遮罩关闭
        modalWrap.firstElementChild.addEventListener('click', hideDataModal);
    })();

    function openDataModal(btn){
        const wrap = document.getElementById('singleDataModal');
        if (!wrap) return;
        const id = btn.getAttribute('data-sub-id') || '';
        const t = btn.getAttribute('data-sub-time') || '';
        let d = btn.getAttribute('data-sub-data') || '';
        try { d = JSON.stringify(JSON.parse(d), null, 2); } catch(e) {}
        document.getElementById('singleDataModalTitle').textContent = '提交数据详情 #' + id;
        document.getElementById('singleDataModalTime').textContent = t;
        document.getElementById('singleDataModalContent').textContent = d;
        wrap.style.display = 'block';
    }
    function hideDataModal(){
        const wrap = document.getElementById('singleDataModal');
        if (wrap) wrap.style.display = 'none';
    }

    // 删除单条数据
    function deleteSingleData(subId) {
        if (!confirm('确定要删除这条数据吗？此操作不可恢复。')) {
            return;
        }
        
        fetch(`{{ url_for('quickform.delete_submission', task_id=task.id) }}?submission_id=${subId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('删除成功');
                location.reload();
            } else {
                alert('删除失败：' + (data.message || '未知错误'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('删除失败：' + error.message);
        });
    }
    
    // 删除全部数据
    function deleteAllData() {
        if (!confirm('确定要删除所有数据吗？此操作不可恢复。')) {
            return;
        }
        
        fetch(`{{ url_for('quickform.delete_all_submissions', task_id=task.id) }}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('删除成功');
                location.reload();
            } else {
                alert('删除失败：' + (data.message || '未知错误'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('删除失败：' + error.message);
        });
    }
</script>
{% endblock %}
{% endblock %}