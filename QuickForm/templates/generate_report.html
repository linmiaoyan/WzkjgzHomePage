<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ¥å‘Šç”Ÿæˆ - QuickForm</title>
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/bootstrap-icons.css') }}" rel="stylesheet">
    <!-- å¼•å…¥marked.jsç”¨äºmarkdownæ¸²æŸ“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- å¼•å…¥highlight.jsç”¨äºä»£ç é«˜äº® -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/highlightjs-github.min.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
        }
        .container {
            margin-top: 30px;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .card-header {
            background-color: #28a745;
            color: white;
            border-radius: 10px 10px 0 0;
        }
        .report-content {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 5px;
            line-height: 1.6;
            max-height: 70vh;
            overflow-y: auto;
            border: 1px solid #dee2e6;
        }
        .markdown-body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            font-size: 16px;
            line-height: 1.6;
            color: #24292e;
        }
        .markdown-body h1, .markdown-body h2, .markdown-body h3, .markdown-body h4, .markdown-body h5, .markdown-body h6 {
            margin-top: 24px;
            margin-bottom: 16px;
            font-weight: 600;
            line-height: 1.25;
        }
        .markdown-body h1 { font-size: 2em; }
        .markdown-body h2 { font-size: 1.5em; }
        .markdown-body h3 { font-size: 1.25em; }
        .markdown-body p { margin-top: 0; margin-bottom: 16px; }
        .markdown-body a { color: #0366d6; text-decoration: none; }
        .markdown-body a:hover { text-decoration: underline; }
        .markdown-body code {
            padding: 0.2em 0.4em;
            margin: 0;
            font-size: 85%;
            background-color: rgba(27, 31, 35, 0.05);
            border-radius: 3px;
        }
        .markdown-body pre {
            padding: 16px;
            overflow: auto;
            font-size: 85%;
            line-height: 1.45;
            background-color: #f6f8fa;
            border-radius: 3px;
        }
        .markdown-body pre code {
            padding: 0;
            margin: 0;
            font-size: 100%;
            word-break: normal;
            white-space: pre;
            background: transparent;
            border: 0;
        }
        .markdown-body ul, .markdown-body ol {
            padding-left: 2em;
            margin-top: 0;
            margin-bottom: 16px;
        }
        .markdown-body li { margin-top: 0.25em; }
        .markdown-body table {
            display: block;
            width: 100%;
            overflow: auto;
            border-spacing: 0;
            border-collapse: collapse;
            margin-bottom: 16px;
        }
        .markdown-body table th {
            font-weight: 600;
        }
        .markdown-body table th, .markdown-body table td {
            padding: 6px 13px;
            border: 1px solid #dfe2e5;
        }
        .markdown-body table tr {
            background-color: #fff;
            border-top: 1px solid #c6cbd1;
        }
        .markdown-body table tr:nth-child(2n) {
            background-color: #f6f8fa;
        }
        .loading-container {
            text-align: center;
            padding: 60px 20px;
        }
        .loading-spinner {
            margin: 0 auto 30px;
            width: 60px;
            height: 60px;
            border: 6px solid #f3f3f3;
            border-top: 6px solid #28a745;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .status-message {
            margin-bottom: 20px;
        }
        .comfort-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin: 30px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .comfort-text h4 {
            color: white;
            margin-bottom: 15px;
        }
        .comfort-text p {
            margin-bottom: 10px;
            opacity: 0.95;
        }
        .progress-info {
            margin-top: 20px;
            padding: 15px;
            background-color: #e7f3ff;
            border-radius: 5px;
            border-left: 4px solid #2196F3;
        }
        .tips-list {
            text-align: left;
            max-width: 600px;
            margin: 0 auto;
        }
        .tips-list li {
            margin: 10px 0;
            padding-left: 10px;
        }
        #prompt-form-container {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    ğŸ“„ åˆ†ææŠ¥å‘Š - {{ task.title if task else 'åŠ è½½ä¸­...' }}
                </h4>
            </div>
            <div class="card-body">
                <div class="alert alert-warning d-flex justify-content-between align-items-center" role="alert">
                    <div>
                        å½“å‰å¤§æ¨¡å‹ï¼š<strong>ç¡…åŸºæµåŠ¨</strong>ï¼ˆé€šè¿‡ç»Ÿä¸€è°ƒç”¨ï¼‰ã€‚å¦‚éœ€ä¿®æ”¹ API Tokenï¼Œè¯·ç‚¹å‡»å³ä¾§æŒ‰é’®ã€‚
                    </div>
                    <a href="{{ url_for('quickform.profile') }}" class="btn btn-sm btn-outline-primary" target="_parent">ä¿®æ”¹API Token</a>
                </div>
                {% if error %}
                    <div class="alert alert-danger">
                        <h5>âš ï¸ ç”ŸæˆæŠ¥å‘Šå¤±è´¥</h5>
                        <p>{{ error }}</p>
                        <button onclick="window.close()" class="btn btn-secondary">å…³é—­çª—å£</button>
                    </div>
                {% elif report %}
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="report-content">
                                <div id="markdown-content" class="markdown-body"></div>
                                <div id="report-content" style="display: none;">{{ report }}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <a href="{{ url_for('quickform.download_report', task_id=task.id) }}" class="btn btn-success me-2">
                            ğŸ“¥ ä¸‹è½½åˆ†ææŠ¥å‘Š
                        </a>
                        <button onclick="if(window.opener) { window.opener.location.reload(); } window.close();" class="btn btn-primary">
                            âœ… å®Œæˆå¹¶è¿”å›
                        </button>
                    </div>
                    
                    {% if task and task.report_generated_at %}
                    <div class="alert alert-info mt-3">
                        <p>â„¹ï¸ æŠ¥å‘Šç”Ÿæˆæ—¶é—´ï¼š{{ task.report_generated_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                    </div>
                    {% endif %}
                {% elif is_processing %}
                    <!-- æ­£åœ¨å¤„ç†ä¸­çš„ç­‰å¾…ç•Œé¢ -->
                    <div class="loading-container">
                        <div class="loading-spinner"></div>
                        <h4 class="status-message">æ­£åœ¨ç”Ÿæˆåˆ†ææŠ¥å‘Š...</h4>
                        <p class="text-muted mb-4" id="status-text">æ­£åœ¨å‡†å¤‡åˆ†æä»»åŠ¡ï¼Œè¯·ç¨å€™...</p>
                        
                        <div class="comfort-text">
                            <h4><i class="bi bi-heart-fill"></i> è¯·ç¨å€™ï¼ŒAIæ­£åœ¨ä¸ºæ‚¨åˆ†ææ•°æ®</h4>
                            <p>ç”Ÿæˆé«˜è´¨é‡çš„åˆ†ææŠ¥å‘Šéœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¿™æ˜¯æ­£å¸¸çš„ã€‚æ‚¨å¯ä»¥ï¼š</p>
                            <ul class="tips-list">
                                <li>â˜• æ”¾æ¾ä¸€ä¸‹ï¼Œå–æ¯èŒ¶</li>
                                <li>ğŸ“š æµè§ˆå…¶ä»–é¡µé¢ï¼ŒæŠ¥å‘Šç”Ÿæˆåä¼šè‡ªåŠ¨æ˜¾ç¤º</li>
                                <li>ğŸ’­ æ€è€ƒä¸€ä¸‹æ‚¨æƒ³è¦ä»æ•°æ®ä¸­äº†è§£ä»€ä¹ˆ</li>
                                <li>âœ¨ è€å¿ƒç­‰å¾…ï¼Œæˆ‘ä»¬æ­£åœ¨ä¸ºæ‚¨å‡†å¤‡æœ€ä¸“ä¸šçš„åˆ†æ</li>
                            </ul>
                        </div>
                        
                        <div class="progress-info" id="progress-info">
                            <strong><i class="bi bi-info-circle"></i> å½“å‰çŠ¶æ€ï¼š</strong>
                            <span id="progress-message">æ­£åœ¨å‡†å¤‡åˆ†æ...</span>
                        </div>
                    </div>
                {% else %}
                    <!-- åˆå§‹çŠ¶æ€ï¼šæ˜¾ç¤ºæç¤ºè¯ç¼–è¾‘è¡¨å• -->
                    <div id="prompt-form-container">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">æç¤ºè¯ç¼–è¾‘</h5>
                            </div>
                            <div class="card-body">
                                <p class="mb-3 text-muted">æ‚¨å¯ä»¥æŸ¥çœ‹å’Œä¿®æ”¹æç¤ºè¯ï¼Œç„¶åå¼€å§‹ç”Ÿæˆåˆ†ææŠ¥å‘Šï¼š</p>
                                <form id="promptForm" method="POST">
                                    <div class="mb-3">
                                        <textarea name="custom_prompt" class="form-control" rows="15" style="font-family: monospace; font-size: 14px;" id="prompt-textarea">{{ preview_prompt if preview_prompt else '' }}</textarea>
                                    </div>
                                    <div class="d-grid gap-2">
                                        <button type="submit" class="btn btn-primary btn-lg">
                                            ğŸ¤– å¼€å§‹ç”ŸæˆæŠ¥å‘Š
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const taskId = {{ task.id if task else 'null' }};
        const isProcessing = {{ 'true' if is_processing else 'false' }};
        let pollInterval = null;
        let pollCount = 0;
        const maxPollCount = 300; // æœ€å¤šè½®è¯¢5åˆ†é’Ÿï¼ˆæ¯1ç§’ä¸€æ¬¡ï¼‰

        // æ¸²æŸ“markdownå†…å®¹
        function renderMarkdown(content) {
            const markdownContainer = document.getElementById('markdown-content');
            if (!markdownContainer || !content) return;
            
            marked.setOptions({
                highlight: function(code, lang) {
                    if (lang && hljs.getLanguage(lang)) {
                        try {
                            return hljs.highlight(code, { language: lang }).value;
                        } catch (err) {}
                    }
                    return hljs.highlightAuto(code).value;
                },
                breaks: true,
                gfm: true
            });
            
            markdownContainer.innerHTML = marked.parse(content);
            hljs.highlightAll();
        }

        // è½®è¯¢æ£€æŸ¥æŠ¥å‘ŠçŠ¶æ€
        function checkReportStatus() {
            if (!taskId) return;
            
            pollCount++;
            if (pollCount > maxPollCount) {
                clearInterval(pollInterval);
                document.getElementById('status-text').textContent = 'è¯·æ±‚è¶…æ—¶ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•';
                return;
            }

            fetch(`{{ url_for('quickform.report_status', task_id=0) }}`.replace('0', taskId))
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('çŠ¶æ€æŸ¥è¯¢é”™è¯¯:', data.error);
                        return;
                    }

                    // æ›´æ–°çŠ¶æ€ä¿¡æ¯
                    const statusText = document.getElementById('status-text');
                    const progressMessage = document.getElementById('progress-message');
                    
                    if (statusText) {
                        statusText.textContent = data.message || 'æ­£åœ¨å¤„ç†ä¸­...';
                    }
                    if (progressMessage) {
                        progressMessage.textContent = data.message || 'æ­£åœ¨å¤„ç†ä¸­...';
                    }

                    // æ£€æŸ¥æ˜¯å¦å®Œæˆ
                    if (data.status === 'completed' && data.report) {
                        clearInterval(pollInterval);
                        // æ˜¾ç¤ºæŠ¥å‘Š
                        location.reload(); // é‡æ–°åŠ è½½é¡µé¢ä»¥æ˜¾ç¤ºæŠ¥å‘Š
                    } else if (data.status === 'error') {
                        clearInterval(pollInterval);
                        document.querySelector('.loading-container').innerHTML = 
                            '<div class="alert alert-danger"><h5>ç”ŸæˆæŠ¥å‘Šå¤±è´¥</h5><p>' + (data.message || 'æœªçŸ¥é”™è¯¯') + '</p><button onclick="window.close()" class="btn btn-secondary">å…³é—­çª—å£</button></div>';
                    }
                })
                .catch(error => {
                    console.error('çŠ¶æ€æŸ¥è¯¢å¤±è´¥:', error);
                });
        }

        // å¤„ç†è¡¨å•æäº¤
        document.addEventListener('DOMContentLoaded', function() {
            // æ¸²æŸ“å·²æœ‰æŠ¥å‘Š
            const reportContent = document.getElementById('report-content');
            if (reportContent && reportContent.textContent.trim()) {
                renderMarkdown(reportContent.textContent);
            }

            // å¦‚æœæ­£åœ¨å¤„ç†ä¸­ï¼Œå¼€å§‹è½®è¯¢
            if (isProcessing && taskId) {
                pollInterval = setInterval(checkReportStatus, 1000);
                checkReportStatus(); // ç«‹å³æ£€æŸ¥ä¸€æ¬¡
            }

            // å¤„ç†è¡¨å•æäº¤
            const promptForm = document.getElementById('promptForm');
            if (promptForm) {
                // å¦‚æœæ²¡æœ‰æç¤ºè¯ï¼Œå…ˆè·å–
                const textarea = document.getElementById('prompt-textarea');
                if (!textarea || !textarea.value.trim()) {
                    // é¡µé¢åŠ è½½æ—¶è·å–æç¤ºè¯
                    fetch(`{{ url_for('quickform.generate_report', task_id=0) }}`.replace('0', taskId))
                        .then(response => response.text())
                        .then(html => {
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(html, 'text/html');
                            const promptText = doc.querySelector('#prompt-textarea');
                            if (promptText && textarea) {
                                textarea.value = promptText.value || promptText.textContent;
                            }
                            document.getElementById('prompt-form-container').style.display = 'block';
                        });
                } else {
                    document.getElementById('prompt-form-container').style.display = 'block';
                }

                promptForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const formData = new FormData(this);
                    fetch(this.action, {
                        method: 'POST',
                        body: formData
                    })
                    .then(async response => {
                        const responseText = await response.text();
                        let responseData = {};
                        try {
                            responseData = JSON.parse(responseText);
                        } catch (e) {
                            // å¦‚æœä¸æ˜¯JSONï¼Œå¯èƒ½æ˜¯HTMLå“åº”
                        }
                        
                        if (response.ok) {
                            // æ˜¾ç¤ºç­‰å¾…ç•Œé¢
                            document.getElementById('prompt-form-container').style.display = 'none';
                            document.querySelector('.card-body').innerHTML = `
                                <div class="loading-container">
                                    <div class="loading-spinner"></div>
                                    <h4 class="status-message">æ­£åœ¨ç”Ÿæˆåˆ†ææŠ¥å‘Š...</h4>
                                    <p class="text-muted mb-4" id="status-text">æ­£åœ¨å‡†å¤‡åˆ†æä»»åŠ¡ï¼Œè¯·ç¨å€™...</p>
                                    <div class="comfort-text">
                                        <h4>â¤ï¸ è¯·ç¨å€™ï¼ŒAIæ­£åœ¨ä¸ºæ‚¨åˆ†ææ•°æ®</h4>
                                        <p>ç”Ÿæˆé«˜è´¨é‡çš„åˆ†ææŠ¥å‘Šéœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¿™æ˜¯æ­£å¸¸çš„ã€‚æ‚¨å¯ä»¥ï¼š</p>
                                        <ul class="tips-list">
                                            <li>â˜• æ”¾æ¾ä¸€ä¸‹ï¼Œå–æ¯èŒ¶</li>
                                            <li>ğŸ“š æµè§ˆå…¶ä»–é¡µé¢ï¼ŒæŠ¥å‘Šç”Ÿæˆåä¼šè‡ªåŠ¨æ˜¾ç¤º</li>
                                            <li>ğŸ’­ æ€è€ƒä¸€ä¸‹æ‚¨æƒ³è¦ä»æ•°æ®ä¸­äº†è§£ä»€ä¹ˆ</li>
                                            <li>âœ¨ è€å¿ƒç­‰å¾…ï¼Œæˆ‘ä»¬æ­£åœ¨ä¸ºæ‚¨å‡†å¤‡æœ€ä¸“ä¸šçš„åˆ†æ</li>
                                        </ul>
                                    </div>
                                    <div class="progress-info" id="progress-info">
                                        <strong>â„¹ï¸ å½“å‰çŠ¶æ€ï¼š</strong>
                                        <span id="progress-message">æ­£åœ¨å‡†å¤‡åˆ†æ...</span>
                                    </div>
                                </div>
                            `;
                            
                            // å¼€å§‹è½®è¯¢
                            pollInterval = setInterval(checkReportStatus, 1000);
                            checkReportStatus();
                        } else {
                            // å¤„ç†é”™è¯¯å“åº”
                            const errorMsg = responseData.error || responseData.message || 'å¯åŠ¨ä»»åŠ¡å¤±è´¥ï¼Œè¯·é‡è¯•';
                            alert(errorMsg);
                            console.error('å¯åŠ¨ä»»åŠ¡å¤±è´¥:', response.status, errorMsg);
                        }
                    })
                    .catch(error => {
                        console.error('æäº¤å¤±è´¥:', error);
                        alert('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•');
                    });
                });
            }
        });
    </script>
</body>
</html>
